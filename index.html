<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#000000" />
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      font-family: 'Poppins', Arial, sans-serif;
      background-color: #121212;
      color: #fff;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      padding: 1rem;
      background: #1f1f1f;
      justify-content: flex-end; /* Alinha a data à direita */
    }
    .video-container {
      width: 100%; /* Ocupa a largura total */
      display: flex;
      justify-content: center; /* Centraliza o vídeo */
      padding: 1rem;
      background: #1f1f1f;
      margin-bottom: 1rem;
    }
    .video-container .video {
      width: 200px; /* Largura padrão de aplicativos */
      height: auto; /* Mantém a proporção */
      object-fit: contain; /* Garante que o vídeo seja totalmente visível */
      border-radius: 8px; /* Opcional: bordas arredondadas */
    }
    .logo {
      height: 120px;
      margin-right: 20px;
      object-fit: contain;
    }
    #mesAtual {
      font-size: 2rem;
      font-style: italic;
      color: #ccc;
      /* flex-grow: 1; Removido para não empurrar a data para a esquerda */
    }
    main, #resultadoFinal, #registroOperacoes {
      width: 100%;
      max-width: 100%;
      padding: 0 1rem;
    }
    .nome-estoque-container {
      padding: 1rem;
    }
    .nome-estoque-container {
      padding: 1rem;
      display: flex;
      justify-content: center;
    }

    .nome-estoque-container input {
      width: 50%;
      max-width: 400px;
      padding: 10px;
      border-radius: 4px;
      border: none;
      background: #2a2a2a;
      color: #fff;
      font-size: 1rem;
    }

    table.estoque-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
      table-layout: fixed;
    }
    table.estoque-table th, table.estoque-table td {
      border: 1px solid #444;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }
    table.estoque-table input {
      width: 100%;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 0.9rem;
      text-align: center;
    }
    table.estoque-table input:focus {
      outline: 1px solid #888;
      background: #333;
    }
    .graficos {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      padding: 0 1rem;
    }
    .grafico-container {
      flex: 1 1 300px;
      min-width: 280px;
    }
    /* Para gráficos pizza e barras lado a lado meio a meio */
    .graficos-top {
      display: flex;
      gap: 1rem;
      padding: 0 1rem;
    }
    .grafico-meio {
      flex: 1 1 50%;
      min-width: 280px;
    }
    #graficoSaidas-container {
      margin-top: 1rem;
      width: 100%;
      padding: 0 1rem;
    }
    #resultadoFinal {
      padding: 20px;
      text-align: center;
      background: #1f1f1f;
      margin-top: 1rem;
    }
    #registroOperacoes {
      position: relative;
      background: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
      font-family: monospace;
      margin-top: 1rem;
    }
    #registroOperacoes ul {
      list-style: none;
      padding-left: 0;
      max-height: 200px;
      overflow-y: auto;
    }
    /* Botão discreto apagar histórico */
    #btnLimparHistorico {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      color: #aaa;
      font-size: 0.85rem;
      cursor: pointer;
      transition: color 0.3s ease;
      padding: 0;
    }
    #btnLimparHistorico:hover {
      color: #fff;
      text-decoration: underline;
    }
    @media screen and (max-width: 768px) {
      .graficos {
        flex-direction: column;
        align-items: stretch;
      }
      .graficos-top {
        flex-direction: column;
      }
      .grafico-meio {
        min-width: 100%;
      }
      #graficoSaidas-container {
        padding: 0 0;
      }
    }
  </style>
</head>
<body>
  <div class="video-container">
    <video class="video" autoplay muted loop playsinline>
      <source src="Dcodeanimation.mp4" type="video/mp4">
    </video>
  </div>

  <header>
    <div id="mesAtual"></div>
  </header>

  <div class="nome-estoque-container">
    <input type="text" placeholder="Digite o nome do estoque" />
  </div>

  <main id="abasContainer">
    <table class="estoque-table">
      <thead>
        <tr>
          <th>Item</th>
          <th>Entrada</th>
          <th>Saída</th>
          <th>Valor</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <div class="graficos-top">
    <div class="grafico-meio">
      <h3>Entrada</h3>
      <canvas id="graficoPizza"></canvas>
    </div>
    <div class="grafico-meio">
      <h3>R$ valores</h3>
      <canvas id="graficoBarras"></canvas>
    </div>
  </div>

  <div id="graficoSaidas-container">
    <h3>Saídas</h3>
    <canvas id="graficoSaidas"></canvas>
  </div>

  <div id="resultadoFinal">
    <p>Entrada Total: <span id="entradaTotal">0</span></p>
    <p>Saída Total: <span id="saidaTotal">0</span></p>
    <p>Saldo Atual: <span id="saldoTotal">0</span></p>
    <p>Valor Total: R$ <span id="valorFinal">0.00</span></p>
  </div>

  <div id="registroOperacoes">
    <button id="btnLimparHistorico" title="Apagar histórico">Apagar Histórico</button>
    <h3>Histórico de Operações</h3>
    <ul id="listaOperacoes"></ul>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Mês Atual
      const mesAtualEl = document.getElementById('mesAtual');
      const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
      const agora = new Date();
      mesAtualEl.textContent = `${meses[agora.getMonth()]} de ${agora.getFullYear()}`;

      // Elementos
      const entradaTotalEl = document.getElementById('entradaTotal');
      const saidaTotalEl = document.getElementById('saidaTotal');
      const saldoTotalEl = document.getElementById('saldoTotal');
      const valorFinalEl = document.getElementById('valorFinal');
      const tabelaBody = document.querySelector('table.estoque-table tbody');
      const listaOperacoes = document.getElementById('listaOperacoes');
      const btnLimparHistorico = document.getElementById('btnLimparHistorico');

      // Gráficos
      const ctxPizza = document.getElementById('graficoPizza').getContext('2d');
      const ctxBarras = document.getElementById('graficoBarras').getContext('2d');
      const ctxSaidas = document.getElementById('graficoSaidas').getContext('2d');

      const chartPizza = new Chart(ctxPizza, {
        type: 'pie',
        data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
        options: { plugins: { legend: { position: 'bottom' } } }
      });

      const chartBarras = new Chart(ctxBarras, {
        type: 'bar',
        data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
        options: { scales: { y: { beginAtZero: true } } }
      });

      const chartSaidas = new Chart(ctxSaidas, {
        type: 'bar',
        data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
        options: { indexAxis: 'y', scales: { x: { beginAtZero: true } } }
      });

      // Cores
      const coresMap = JSON.parse(localStorage.getItem('coresMap') || '{}');
      function gerarCor(nome) {
        if (!coresMap[nome]) {
          const r = Math.floor(Math.random() * 156 + 100);
          const g = Math.floor(Math.random() * 156 + 100);
          const b = Math.floor(Math.random() * 156 + 100);
          coresMap[nome] = `rgb(${r},${g},${b})`;
          localStorage.setItem('coresMap', JSON.stringify(coresMap));
        }
        return coresMap[nome];
      }

      // Adicionar linha vazia para inserir dados
      function adicionarLinha() {
        const linha = document.createElement('tr');
        linha.innerHTML = `
          <td><input type="text" class="item" autocomplete="off" /></td>
          <td><input type="number" class="entrada" min="0" step="any" value="" autocomplete="off"/></td>
          <td><input type="number" class="saida" min="0" step="any" value="" autocomplete="off"/></td>
          <td><input type="number" class="valor" min="0" step="0.01" value="" autocomplete="off"/></td>
        `;
        tabelaBody.appendChild(linha);
        adicionarEventosLinha(linha);
      }

      // Eventos inputs da linha
      function adicionarEventosLinha(linha) {
        const inputs = linha.querySelectorAll('input');
        inputs.forEach(input => {
          input.addEventListener('input', () => {
            atualizarResumo();
            atualizarGraficos();
            salvarTabela();
            verificarLinhaFinal();
            removerLinhasVazias();
          });
        });

        linha.querySelector('.entrada').addEventListener('change', () => {
          const item = linha.querySelector('.item').value.trim();
          const valor = linha.querySelector('.entrada').value;
          if (item && valor > 0) registrarOperacao('entrada', item, valor);
        });
        linha.querySelector('.saida').addEventListener('change', () => {
          const item = linha.querySelector('.item').value.trim();
          const valor = linha.querySelector('.saida').value;
          if (item && valor > 0) registrarOperacao('saida', item, valor);
        });
      }

      // Verifica se última linha tem dados, se sim adiciona nova linha
      function verificarLinhaFinal() {
        const linhas = [...tabelaBody.querySelectorAll('tr')];
        const ultima = linhas[linhas.length - 1];
        if (ultima && [...ultima.querySelectorAll('input')].some(inp => inp.value.trim() !== '' && inp.value !== '0')) {
          adicionarLinha();
        }
      }

      // Remove linhas vazias (menos a última)
      function removerLinhasVazias() {
        const linhas = [...tabelaBody.querySelectorAll('tr')];
        linhas.forEach((linha, i) => {
          const inputs = linha.querySelectorAll('input');
          const vazia = [...inputs].every(input => input.value.trim() === '' || parseFloat(input.value) === 0);
          if (vazia && i !== linhas.length - 1) linha.remove();
        });
      }

      // Atualiza resumo numérico
      function atualizarResumo() {
        let entrada = 0, saida = 0, saldo = 0, valor = 0;
        const linhas = [...tabelaBody.querySelectorAll('tr')];
        linhas.forEach(linha => {
          const ent = parseFloat(linha.querySelector('.entrada').value) || 0;
          const sai = parseFloat(linha.querySelector('.saida').value) || 0;
          const val = parseFloat(linha.querySelector('.valor').value) || 0;
          entrada += ent;
          saida += sai;
          saldo += (ent - sai);
          valor += val;
        });
        entradaTotalEl.textContent = entrada;
        saidaTotalEl.textContent = saida;
        saldoTotalEl.textContent = saldo;
        valorFinalEl.textContent = valor.toFixed(2);
      }

      // Atualiza os gráficos
      function atualizarGraficos() {
        const labels = [], entradas = [], valores = [], cores = [];
        const dataSaida = {}, corSaidaPorItem = {};
        const linhas = [...tabelaBody.querySelectorAll('tr')];

        linhas.forEach(linha => {
          const nome = linha.querySelector('.item').value.trim();
          const ent = parseFloat(linha.querySelector('.entrada').value) || 0;
          const sai = parseFloat(linha.querySelector('.saida').value) || 0;
          const val = parseFloat(linha.querySelector('.valor').value) || 0;

          if (nome) {
            const cor = gerarCor(nome);
            if (ent > 0) {
              labels.push(nome);
              entradas.push(ent);
              valores.push(val);
              cores.push(cor);
            }
            if (sai > 0) {
              dataSaida[nome] = (dataSaida[nome] || 0) + sai;
              corSaidaPorItem[nome] = cor;
            }
          }
        });

        chartPizza.data.labels = labels;
        chartPizza.data.datasets[0].data = entradas;
        chartPizza.data.datasets[0].backgroundColor = cores;
        chartPizza.update();

        chartBarras.data.labels = labels;
        chartBarras.data.datasets[0].data = valores;
        chartBarras.data.datasets[0].backgroundColor = cores;
        chartBarras.update();

        const saidaLabels = Object.keys(dataSaida);
        chartSaidas.data.labels = saidaLabels;
        chartSaidas.data.datasets[0].data = saidaLabels.map(l => dataSaida[l]);
        chartSaidas.data.datasets[0].backgroundColor = saidaLabels.map(l => corSaidaPorItem[l]);
        chartSaidas.update();
      }

      // Salva tabela no localStorage
      function salvarTabela() {
        const linhas = [...tabelaBody.querySelectorAll('tr')].map(linha => ({
          item: linha.querySelector('.item').value,
          entrada: linha.querySelector('.entrada').value,
          saida: linha.querySelector('.saida').value,
          valor: linha.querySelector('.valor').value
        }));
        localStorage.setItem('dadosTabela', JSON.stringify(linhas));
      }

      // Registra operação no histórico
      function registrarOperacao(tipo, item, quantidade) {
        const data = new Date();
        const dataFormatada = `${data.getDate().toString().padStart(2, '0')}/${(data.getMonth()+1).toString().padStart(2, '0')}/${data.getFullYear()}`;
        const texto = `[${dataFormatada}] ${tipo.toUpperCase()}: ${item} - ${quantidade}`;
        const li = document.createElement('li');
        li.textContent = texto;
        listaOperacoes.prepend(li);

        const historico = JSON.parse(localStorage.getItem('historicoOperacoes') || '[]');
        historico.unshift(texto);
        localStorage.setItem('historicoOperacoes', JSON.stringify(historico));
      }

      // Restaura histórico e tabela do localStorage
      function restaurarHistorico() {
        const historico = JSON.parse(localStorage.getItem('historicoOperacoes') || '[]');
        listaOperacoes.innerHTML = '';
        historico.forEach(txt => {
          const li = document.createElement('li');
          li.textContent = txt;
          listaOperacoes.appendChild(li);
        });

        const dadosTabela = JSON.parse(localStorage.getItem('dadosTabela') || '[]');
        tabelaBody.innerHTML = '';

        dadosTabela.forEach(data => {
          const linha = document.createElement('tr');
          linha.innerHTML = `
            <td><input type="text" class="item" value="${data.item}" autocomplete="off"/></td>
            <td><input type="number" class="entrada" min="0" step="any" value="${data.entrada}" autocomplete="off"/></td>
            <td><input type="number" class="saida" min="0" step="any" value="${data.saida}" autocomplete="off"/></td>
            <td><input type="number" class="valor" min="0" step="0.01" value="${data.valor}" autocomplete="off"/></td>
          `;
          tabelaBody.appendChild(linha);
          adicionarEventosLinha(linha);
        });

        adicionarLinha();
        atualizarResumo();
        atualizarGraficos();
      }

      // Inicializa SortableJS para drag and drop
      new Sortable(tabelaBody, {
        animation: 150,
        ghostClass: 'arrastando',
        onEnd: () => {
          salvarTabela();
        }
      });

      // Botão apagar histórico
      btnLimparHistorico.addEventListener('click', () => {
        if (confirm('Tem certeza que deseja apagar todo o histórico de operações?')) {
          localStorage.removeItem('historicoOperacoes');
          listaOperacoes.innerHTML = '';
        }
      });

      restaurarHistorico();
      verificarLinhaFinal();

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js')
          .then(() => console.log('Service Worker registrado com sucesso!'))
          .catch(err => console.error('Erro ao registrar Service Worker:', err));
      }
    });
  </script>
</body>
</html>